<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Products Hub - Apartment Remodel</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                margin: 0;
                font-size: 2.5em;
                font-weight: 300;
            }

            .header p {
                margin-top: 10px;
                font-size: 1.1em;
                opacity: 0.9;
            }

            .nav {
                display: flex;
                justify-content: center;
                gap: 15px;
                flex-wrap: wrap;
                margin-top: 20px;
            }

            .nav a {
                color: white;
                text-decoration: none;
                padding: 8px 16px;
                border-radius: 5px;
                background: rgba(255, 255, 255, 0.2);
                transition: background 0.3s ease;
            }

            .nav a:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .content {
                padding: 30px;
            }

            .filters {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
                flex-wrap: wrap;
                gap: 15px;
            }

            .filter-group {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .filter-group label {
                font-weight: bold;
                color: #333;
            }

            .filter-group select,
            .filter-group input {
                padding: 8px 12px;
                border: 2px solid #667eea;
                border-radius: 5px;
                font-size: 14px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                border-left: 4px solid #667eea;
            }

            .stat-card h3 {
                margin: 0 0 10px 0;
                color: #333;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .stat-card .value {
                font-size: 1.8em;
                font-weight: bold;
                color: #667eea;
            }

            .products-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 20px;
            }

            .product-card {
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s, box-shadow 0.3s;
                border: 2px solid transparent;
            }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
                border-color: #667eea;
            }

            .product-image {
                width: 100%;
                height: 200px;
                object-fit: cover;
                background: #f0f0f0;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #999;
                font-size: 3em;
            }

            .product-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .card-header {
                padding: 15px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .card-header h3 {
                margin: 0 0 5px 0;
                font-size: 1.2em;
            }

            .room-badge {
                display: inline-block;
                background: rgba(255, 255, 255, 0.3);
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 0.85em;
                margin-right: 5px;
                margin-top: 5px;
            }

            .favorite-badge {
                display: inline-block;
                background: rgba(255, 193, 7, 0.3);
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 0.85em;
                margin-right: 5px;
                margin-top: 5px;
                color: #ffc107;
                font-weight: bold;
            }

            .card-body {
                padding: 20px;
            }

            .product-detail {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #f0f0f0;
            }

            .product-detail:last-child {
                border-bottom: none;
            }

            .product-detail label {
                font-weight: 600;
                color: #666;
            }

            .product-detail value {
                color: #333;
                font-weight: bold;
            }

            .product-notes {
                margin-top: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 5px;
                font-size: 0.9em;
                color: #666;
                max-height: 100px;
                overflow-y: auto;
            }

            .product-links {
                margin-top: 10px;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .product-link {
                display: inline-block;
                padding: 5px 10px;
                background: #667eea;
                color: white;
                text-decoration: none;
                border-radius: 4px;
                font-size: 0.85em;
                transition: background 0.3s;
            }

            .product-link:hover {
                background: #5568d3;
            }

            .card-footer {
                padding: 15px 20px;
                background: #f8f9fa;
                border-top: 1px solid #e0e0e0;
                display: flex;
                gap: 10px;
            }

            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
                text-decoration: none;
                display: inline-block;
                flex: 1;
                text-align: center;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover {
                background: #5568d3;
            }

            .btn-success {
                background: #28a745;
                color: white;
            }

            .btn-success:hover {
                background: #218838;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
            }

            .btn-add {
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #28a745;
                color: white;
                font-size: 2em;
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
                transition: all 0.3s;
                z-index: 100;
            }

            .btn-add:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.6);
                animation: fadeIn 0.3s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .modal-content {
                background-color: #fefefe;
                margin: 50px auto;
                padding: 0;
                border-radius: 15px;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s;
            }

            @keyframes slideIn {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-header {
                padding: 25px 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 15px 15px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 1.8em;
                font-weight: 300;
            }

            .close {
                color: white;
                font-size: 35px;
                font-weight: 300;
                cursor: pointer;
                background: none;
                border: none;
                line-height: 1;
                transition: transform 0.3s;
            }

            .close:hover {
                transform: scale(1.2);
            }

            .modal-body {
                padding: 30px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #333;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid #e0e0e0;
                border-radius: 5px;
                font-size: 14px;
                font-family: inherit;
                transition: border-color 0.3s;
            }

            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: #667eea;
            }

            .form-group textarea {
                min-height: 100px;
                resize: vertical;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .links-container {
                border: 2px dashed #e0e0e0;
                border-radius: 5px;
                padding: 15px;
                margin-top: 10px;
            }

            .link-item {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
                align-items: center;
            }

            .link-item input {
                flex: 1;
            }

            .link-item button {
                padding: 8px 12px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .btn-add-link {
                margin-top: 10px;
                padding: 8px 16px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }

            .image-preview {
                width: 100%;
                max-height: 200px;
                object-fit: cover;
                border-radius: 5px;
                margin-top: 10px;
                display: none;
            }

            .upload-zone {
                border: 2px dashed #ccc;
                border-radius: 8px;
                padding: 30px;
                text-align: center;
                background: #f9f9f9;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }

            .upload-zone:hover {
                border-color: #667eea;
                background: #f0f0ff;
            }

            .upload-zone.dragover {
                border-color: #667eea;
                background: #e6e6ff;
                transform: scale(1.02);
            }

            .upload-zone p {
                margin: 10px 0 5px 0;
                color: #666;
            }

            .upload-zone .file-name {
                font-size: 12px;
                color: #999;
                margin-top: 5px;
            }

            .upload-options {
                display: flex;
                gap: 10px;
                align-items: center;
                margin-top: 15px;
            }

            .upload-options .separator {
                color: #999;
                font-weight: bold;
            }

            input[type='file'] {
                display: none;
            }

            .image-gallery {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
                margin-top: 10px;
            }

            .gallery-item {
                position: relative;
                aspect-ratio: 1;
                border-radius: 8px;
                overflow: hidden;
                border: 2px solid #e0e0e0;
                cursor: pointer;
                transition: all 0.3s;
            }

            .gallery-item:hover {
                transform: scale(1.05);
                border-color: #667eea;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }

            .gallery-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .gallery-item .heart-btn {
                position: absolute;
                top: 8px;
                right: 8px;
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                font-size: 18px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
                z-index: 10;
            }

            .gallery-item .heart-btn:hover {
                background: white;
                transform: scale(1.1);
            }

            .gallery-item .heart-btn.active {
                background: #ff4757;
            }

            .gallery-item .delete-btn {
                position: absolute;
                top: 8px;
                left: 8px;
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 50%;
                width: 28px;
                height: 28px;
                font-size: 14px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s;
                color: #dc3545;
                z-index: 10;
            }

            .gallery-item .delete-btn:hover {
                background: #dc3545;
                color: white;
            }

            .gallery-item.is-thumbnail {
                border-color: #ff4757;
                border-width: 3px;
            }

            .modal-footer {
                padding: 20px 30px;
                background: #f8f9fa;
                border-top: 1px solid #e0e0e0;
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .loading {
                text-align: center;
                padding: 60px 20px;
                font-size: 1.2em;
                color: #667eea;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #666;
            }

            .empty-state h3 {
                font-size: 1.5em;
                margin-bottom: 10px;
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                display: none;
                z-index: 2000;
                max-width: 300px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                color: white;
            }

            .notification.success {
                background: #28a745;
            }

            .notification.error {
                background: #dc3545;
            }

            @media (max-width: 768px) {
                .products-grid {
                    grid-template-columns: 1fr;
                }

                .form-row {
                    grid-template-columns: 1fr;
                }

                .modal-content {
                    width: 95%;
                    margin: 20px auto;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>🛍️ Products Hub</h1>
                <p>Manage products to buy for your apartment remodel</p>
                <div class="nav">
                    <a href="../home.html">🏠 Home</a>
                    <a href="budget-overview.html">📊 Dashboard</a>
                    <a href="room-editor.html">✏️ Editor</a>
                    <a href="products.html">🛍️ Products</a>
                    <a href="../README.html">📖 Documentation</a>
                </div>
            </div>

            <div class="content">
                <div class="filters">
                    <div class="filter-group">
                        <label for="roomFilter">Filter by Room:</label>
                        <select id="roomFilter" onchange="filterProducts()">
                            <option value="all">All Rooms</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">Status:</label>
                        <select id="statusFilter" onchange="filterProducts()">
                            <option value="all">All Status</option>
                            <option value="Planning">Planning</option>
                            <option value="Pending">Pending</option>
                            <option value="Ordered">Ordered</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="favoritesFilter">⭐ Favorites:</label>
                        <select
                            id="favoritesFilter"
                            onchange="filterProducts()"
                        >
                            <option value="all">All Items</option>
                            <option value="favorites">Favorites Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchBox">Search:</label>
                        <input
                            type="text"
                            id="searchBox"
                            placeholder="Search products..."
                            oninput="filterProducts()"
                        />
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Products</h3>
                        <div class="value" id="totalProducts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>⭐ Favorites</h3>
                        <div class="value" id="favoritesCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Budget Total</h3>
                        <div class="value" id="totalBudget">S/ 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Actual Total</h3>
                        <div class="value" id="totalActual">S/ 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Items to Buy</h3>
                        <div class="value" id="itemsToBuy">0</div>
                    </div>
                </div>

                <div id="productsContainer">
                    <div class="loading">Loading products...</div>
                </div>
            </div>
        </div>

        <!-- Add Product Button -->
        <button
            class="btn-add"
            onclick="openAddProductModal()"
            title="Add New Product"
        >
            +
        </button>

        <!-- Product Editor Modal -->
        <div id="productModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Edit Product</h2>
                    <button class="close" onclick="closeModal()">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productRoom" />
                        <input type="hidden" id="productIndex" />

                        <div class="form-group">
                            <label for="productName">Product Name *</label>
                            <input
                                type="text"
                                id="productName"
                                required
                                placeholder="e.g., Sofa 3-seater"
                            />
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="productRoom">Room *</label>
                                <select id="productRoomSelect" required>
                                    <option value="">Select Room</option>
                                    <option value="sala">Sala</option>
                                    <option value="cocina">Cocina</option>
                                    <option value="cuarto1">Cuarto 1</option>
                                    <option value="cuarto2">Cuarto 2</option>
                                    <option value="cuarto3">Cuarto 3</option>
                                    <option value="bano1">Baño 1</option>
                                    <option value="bano2">Baño 2</option>
                                    <option value="bano_visita">
                                        Baño Visita
                                    </option>
                                    <option value="balcon">Balcón</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productStatus">Status</label>
                                <select id="productStatus">
                                    <option value="Planning">Planning</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Ordered">Ordered</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="productQuantity">Quantity</label>
                                <input
                                    type="number"
                                    id="productQuantity"
                                    value="1"
                                    min="0"
                                    step="0.01"
                                />
                            </div>
                            <div class="form-group">
                                <label for="productUnit">Unit</label>
                                <input
                                    type="text"
                                    id="productUnit"
                                    placeholder="e.g., pcs, m2, units"
                                />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="productBudgetPrice"
                                    >Budget Price (S/)</label
                                >
                                <input
                                    type="number"
                                    id="productBudgetPrice"
                                    min="0"
                                    step="0.01"
                                    placeholder="0.00"
                                />
                            </div>
                            <div class="form-group">
                                <label for="productActualPrice"
                                    >Actual Price (S/)</label
                                >
                                <input
                                    type="number"
                                    id="productActualPrice"
                                    min="0"
                                    step="0.01"
                                    placeholder="0.00"
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="productImage">Product Image</label>

                            <!-- Drag and Drop Zone -->
                            <div
                                class="upload-zone"
                                id="uploadZone"
                                onclick="document.getElementById('fileInput').click()"
                            >
                                <div>📸</div>
                                <p>
                                    <strong
                                        >Drop image here or click to
                                        browse</strong
                                    >
                                </p>
                                <p style="font-size: 12px; color: #999">
                                    Supports: JPG, PNG, GIF, WebP
                                </p>
                                <p class="file-name" id="fileName"></p>
                            </div>
                            <input
                                type="file"
                                id="fileInput"
                                accept="image/*"
                                onchange="handleFileSelect(event)"
                            />

                            <div class="upload-options">
                                <span class="separator">OR</span>
                                <input
                                    type="url"
                                    id="productImage"
                                    placeholder="Paste image URL"
                                    oninput="previewImage()"
                                    style="flex: 1"
                                />
                                <button
                                    type="button"
                                    class="btn btn-primary"
                                    onclick="addImageFromUrl()"
                                    style="padding: 8px 16px"
                                >
                                    Add to Gallery
                                </button>
                            </div>

                            <img id="imagePreview" class="image-preview" />
                        </div>

                        <div
                            class="form-group"
                            id="gallerySection"
                            style="display: none"
                        >
                            <label
                                >Image Gallery
                                <span style="font-size: 12px; color: #999"
                                    >(Click ❤️ to set as thumbnail)</span
                                ></label
                            >
                            <div class="image-gallery" id="imageGallery"></div>
                        </div>

                        <div class="form-group">
                            <label>Product Links</label>
                            <div class="links-container" id="linksContainer">
                                <div class="link-item">
                                    <input
                                        type="text"
                                        placeholder="Link name (e.g., Amazon)"
                                        class="link-name"
                                    />
                                    <input
                                        type="url"
                                        placeholder="https://..."
                                        class="link-url"
                                    />
                                    <button
                                        type="button"
                                        onclick="removeLinkItem(this)"
                                        style="display: none"
                                    >
                                        Remove
                                    </button>
                                </div>
                            </div>
                            <button
                                type="button"
                                class="btn-add-link"
                                onclick="addLinkItem()"
                            >
                                + Add Link
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="productNotes">Notes & Details</label>
                            <textarea
                                id="productNotes"
                                placeholder="Add any important notes, specifications, or details about this product..."
                            ></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="closeModal()"
                    >
                        Cancel
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        onclick="saveProduct()"
                    >
                        Save Product
                    </button>
                </div>
            </div>
        </div>

        <div class="notification" id="notification"></div>

        <script>
            let allProducts = [];
            let filteredProducts = [];
            let currentEditProduct = null;
            let currentImages = []; // Store images for current product being edited

            const roomNames = {
                cocina: 'Cocina',
                sala: 'Sala',
                cuarto1: 'Cuarto 1',
                cuarto2: 'Cuarto 2',
                cuarto3: 'Cuarto 3',
                bano1: 'Baño 1',
                bano2: 'Baño 2',
                bano_visita: 'Baño Visita',
                balcon: 'Balcón',
            };

            function showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }

            function formatCurrency(value) {
                return `S/ ${Math.round(value).toLocaleString('es-PE')}`;
            }

            async function loadProducts() {
                try {
                    const rooms = Object.keys(roomNames);
                    allProducts = [];

                    for (const room of rooms) {
                        const response = await fetch(`/api/load-room/${room}`);
                        const result = await response.json();

                        if (result.success && result.roomData) {
                            result.roomData.items.forEach((item, index) => {
                                if (item.category === 'Products') {
                                    allProducts.push({
                                        ...item,
                                        room: room,
                                        roomDisplayName: roomNames[room],
                                        originalIndex: index,
                                        uniqueId: `${room}-${index}`, // Unique identifier
                                    });
                                }
                            });
                        }
                    }

                    // Populate room filter
                    const roomFilter = document.getElementById('roomFilter');
                    roomFilter.innerHTML =
                        '<option value="all">All Rooms</option>';
                    Object.keys(roomNames).forEach((room) => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = roomNames[room];
                        roomFilter.appendChild(option);
                    });

                    filteredProducts = [...allProducts];
                    displayProducts();
                    updateStats();
                } catch (error) {
                    console.error('Error loading products:', error);
                    showNotification(
                        'Error loading products: ' + error.message,
                        'error'
                    );
                    document.getElementById('productsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Products</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                }
            }

            function filterProducts() {
                const roomFilter = document.getElementById('roomFilter').value;
                const statusFilter =
                    document.getElementById('statusFilter').value;
                const favoritesFilter =
                    document.getElementById('favoritesFilter').value;
                const searchText = document
                    .getElementById('searchBox')
                    .value.toLowerCase();

                filteredProducts = allProducts.filter((product) => {
                    const matchRoom =
                        roomFilter === 'all' || product.room === roomFilter;
                    const matchStatus =
                        statusFilter === 'all' ||
                        product.status === statusFilter;
                    const matchFavorites =
                        favoritesFilter === 'all' ||
                        (favoritesFilter === 'favorites' &&
                            product.favorite === true);
                    const matchSearch =
                        !searchText ||
                        product.description
                            .toLowerCase()
                            .includes(searchText) ||
                        (product.notes &&
                            product.notes.toLowerCase().includes(searchText));

                    return (
                        matchRoom &&
                        matchStatus &&
                        matchFavorites &&
                        matchSearch
                    );
                });

                displayProducts();
                updateStats();
            }

            function displayProducts() {
                const container = document.getElementById('productsContainer');

                if (filteredProducts.length === 0) {
                    container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Products Found</h3>
                        <p>Try adjusting your filters or add a new product using the + button.</p>
                    </div>
                `;
                    return;
                }

                // Sort products: favorites first, then by room
                const sortedProducts = [...filteredProducts].sort((a, b) => {
                    // Favorites first
                    if (a.favorite && !b.favorite) return -1;
                    if (!a.favorite && b.favorite) return 1;
                    // Then sort by room name
                    return a.roomDisplayName.localeCompare(b.roomDisplayName);
                });

                const grid = document.createElement('div');
                grid.className = 'products-grid';

                sortedProducts.forEach((product, index) => {
                    const card = createProductCard(product, index);
                    grid.appendChild(card);
                });

                container.innerHTML = '';
                container.appendChild(grid);
            }

            function createProductCard(product, index) {
                const card = document.createElement('div');
                card.className = 'product-card';

                const budgetPrice = product.budgetRate || 0;
                const actualPrice = product.actualRate || 0;
                const quantity = product.quantity || 1;
                const subtotal =
                    (actualPrice > 0 ? actualPrice : budgetPrice) * quantity;

                // Get thumbnail from images array (new) or fallback to imageUrl (old)
                const images = product.images || [];
                const thumbnailImage = images.find((img) => img.isThumbnail);
                const thumbnailUrl =
                    thumbnailImage?.url || product.imageUrl || '';
                // For backward compatibility: if no images array but has imageUrl, show it unless showImage is explicitly false
                const showThumbnail =
                    !!thumbnailImage ||
                    (product.imageUrl && product.showImage !== false);

                const links = product.links || [];
                const notes = product.notes || '';

                card.innerHTML = `
                ${
                    thumbnailUrl && showThumbnail
                        ? `<div class="product-image"><img src="${thumbnailUrl}" alt="${product.description}" onerror="this.parentElement.innerHTML='📦'"></div>`
                        : `<div class="product-image">📦</div>`
                }
                <div class="card-header">
                    <h3>${product.description || 'Unnamed Product'}</h3>
                    ${
                        product.favorite
                            ? '<span class="favorite-badge">⭐ Favorite</span>'
                            : ''
                    }
                    <span class="room-badge">${product.roomDisplayName}</span>
                    <span class="room-badge" style="background: ${getStatusColor(
                        product.status
                    )};">${product.status || 'Planning'}</span>
                </div>
                <div class="card-body">
                    <div class="product-detail">
                        <label>Quantity:</label>
                        <value>${quantity} ${product.unit || ''}</value>
                    </div>
                    <div class="product-detail">
                        <label>Budget Price:</label>
                        <value>${formatCurrency(budgetPrice)}</value>
                    </div>
                    <div class="product-detail">
                        <label>Actual Price:</label>
                        <value>${formatCurrency(actualPrice)}</value>
                    </div>
                    <div class="product-detail">
                        <label>Subtotal:</label>
                        <value style="color: #667eea; font-size: 1.1em;">${formatCurrency(
                            subtotal
                        )}</value>
                    </div>
                    ${
                        links.length > 0
                            ? `
                        <div class="product-links">
                            ${links
                                .map(
                                    (link) =>
                                        `<a href="${link.url}" target="_blank" class="product-link">${link.name}</a>`
                                )
                                .join('')}
                        </div>
                    `
                            : ''
                    }
                    ${notes ? `<div class="product-notes">${notes}</div>` : ''}
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary" onclick="editProduct('${
                        product.uniqueId
                    }')">✏️ Edit</button>
                    ${
                        links.length > 0
                            ? `<button class="btn btn-success" onclick="openFirstLink('${product.uniqueId}')">🛒 Buy</button>`
                            : ''
                    }
                </div>
            `;

                return card;
            }

            function getStatusColor(status) {
                const colors = {
                    Planning: 'rgba(255, 255, 255, 0.3)',
                    Pending: 'rgba(255, 193, 7, 0.6)',
                    Ordered: 'rgba(0, 123, 255, 0.6)',
                    Completed: 'rgba(40, 167, 69, 0.6)',
                };
                return colors[status] || 'rgba(255, 255, 255, 0.3)';
            }

            function updateStats() {
                const totalProducts = filteredProducts.length;
                const favoritesCount = filteredProducts.filter(
                    (p) => p.favorite === true
                ).length;
                const totalBudget = filteredProducts.reduce((sum, p) => {
                    const price = p.budgetRate || 0;
                    const qty = p.quantity || 1;
                    return sum + price * qty;
                }, 0);
                const totalActual = filteredProducts.reduce((sum, p) => {
                    const price = p.actualRate || 0;
                    const qty = p.quantity || 1;
                    return sum + price * qty;
                }, 0);
                const itemsToBuy = filteredProducts.filter(
                    (p) => p.status === 'Planning' || p.status === 'Pending'
                ).length;

                document.getElementById('totalProducts').textContent =
                    totalProducts;
                document.getElementById('favoritesCount').textContent =
                    favoritesCount;
                document.getElementById('totalBudget').textContent =
                    formatCurrency(totalBudget);
                document.getElementById('totalActual').textContent =
                    formatCurrency(totalActual);
                document.getElementById('itemsToBuy').textContent = itemsToBuy;
            }

            function openAddProductModal() {
                currentEditProduct = null;
                currentImages = []; // Reset gallery
                document.getElementById('modalTitle').textContent =
                    'Add New Product';
                document.getElementById('productForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                renderGallery(); // Hide gallery section

                // Reset links container
                document.getElementById('linksContainer').innerHTML = `
                <div class="link-item">
                    <input type="text" placeholder="Link name (e.g., Amazon)" class="link-name" />
                    <input type="url" placeholder="https://..." class="link-url" />
                    <button type="button" onclick="removeLinkItem(this)" style="display: none;">Remove</button>
                </div>
            `;

                document.getElementById('productModal').style.display = 'block';
            }

            function editProduct(uniqueId) {
                currentEditProduct = filteredProducts.find(
                    (p) => p.uniqueId === uniqueId
                );
                if (!currentEditProduct) {
                    showNotification('Product not found', 'error');
                    return;
                }

                document.getElementById('modalTitle').textContent =
                    'Edit Product';

                // Populate form
                document.getElementById('productName').value =
                    currentEditProduct.description || '';
                document.getElementById('productRoomSelect').value =
                    currentEditProduct.room || '';
                document.getElementById('productStatus').value =
                    currentEditProduct.status || 'Planning';
                document.getElementById('productQuantity').value =
                    currentEditProduct.quantity || 1;
                document.getElementById('productUnit').value =
                    currentEditProduct.unit || '';
                document.getElementById('productBudgetPrice').value =
                    currentEditProduct.budgetRate || 0;
                document.getElementById('productActualPrice').value =
                    currentEditProduct.actualRate || 0;
                document.getElementById('productNotes').value =
                    currentEditProduct.notes || '';

                // Load images into gallery - ensure it's always an array
                currentImages = [];

                // Check if product has images array
                if (
                    Array.isArray(currentEditProduct.images) &&
                    currentEditProduct.images.length > 0
                ) {
                    currentImages = currentEditProduct.images.map((img) => ({
                        url: img.url || '',
                        isThumbnail: img.isThumbnail === true,
                        uploadedAt: img.uploadedAt || new Date(),
                    }));
                }
                // Backward compatibility: if no images array but has imageUrl, convert it
                else if (
                    currentEditProduct.imageUrl &&
                    currentEditProduct.imageUrl.trim() !== ''
                ) {
                    // If showImage is undefined or true, set as thumbnail
                    const shouldBeThumbnail =
                        currentEditProduct.showImage !== false;
                    currentImages = [
                        {
                            url: currentEditProduct.imageUrl,
                            isThumbnail: shouldBeThumbnail,
                            uploadedAt: new Date(),
                        },
                    ];
                }

                renderGallery();
                document.getElementById('imagePreview').style.display = 'none';

                // Populate links
                const linksContainer =
                    document.getElementById('linksContainer');
                linksContainer.innerHTML = '';
                const links = currentEditProduct.links || [];

                if (links.length === 0) {
                    linksContainer.innerHTML = `
                    <div class="link-item">
                        <input type="text" placeholder="Link name (e.g., Amazon)" class="link-name" />
                        <input type="url" placeholder="https://..." class="link-url" />
                        <button type="button" onclick="removeLinkItem(this)" style="display: none;">Remove</button>
                    </div>
                `;
                } else {
                    links.forEach((link) => {
                        const linkItem = document.createElement('div');
                        linkItem.className = 'link-item';
                        linkItem.innerHTML = `
                        <input type="text" placeholder="Link name" class="link-name" value="${link.name}" />
                        <input type="url" placeholder="https://..." class="link-url" value="${link.url}" />
                        <button type="button" onclick="removeLinkItem(this)">Remove</button>
                    `;
                        linksContainer.appendChild(linkItem);
                    });
                }

                document.getElementById('productModal').style.display = 'block';
            }

            function closeModal() {
                document.getElementById('productModal').style.display = 'none';
                currentEditProduct = null;
            }

            function previewImage() {
                const imageUrl = document
                    .getElementById('productImage')
                    .value.trim();
                const preview = document.getElementById('imagePreview');

                if (imageUrl) {
                    preview.src = imageUrl;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            }

            // Add image from URL to gallery
            function addImageFromUrl() {
                const imageUrl = document
                    .getElementById('productImage')
                    .value.trim();
                if (!imageUrl) {
                    showNotification('Please enter an image URL', 'error');
                    return;
                }

                // Add to current images array
                currentImages.push({
                    url: imageUrl,
                    isThumbnail: currentImages.length === 0,
                    uploadedAt: new Date(),
                });

                // Update gallery display
                renderGallery();

                // Clear inputs
                document.getElementById('productImage').value = '';
                document.getElementById('imagePreview').style.display = 'none';

                showNotification('Image added to gallery!', 'success');
            }

            // Render the image gallery
            function renderGallery() {
                const galleryContainer =
                    document.getElementById('imageGallery');
                const gallerySection =
                    document.getElementById('gallerySection');

                if (currentImages.length === 0) {
                    gallerySection.style.display = 'none';
                    return;
                }

                gallerySection.style.display = 'block';
                galleryContainer.innerHTML = '';

                currentImages.forEach((image, index) => {
                    const item = document.createElement('div');
                    item.className =
                        'gallery-item' +
                        (image.isThumbnail ? ' is-thumbnail' : '');

                    item.innerHTML = `
                    <img src="${image.url}" alt="Product image ${
                        index + 1
                    }" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;background:#f0f0f0;\\'>❌</div>'">
                    <button class="delete-btn" onclick="removeImage(${index})" title="Remove image">×</button>
                    <button class="heart-btn ${
                        image.isThumbnail ? 'active' : ''
                    }" onclick="setThumbnail(${index})" title="Set as thumbnail">
                        ${image.isThumbnail ? '❤️' : '🤍'}
                    </button>
                `;

                    galleryContainer.appendChild(item);
                });
            }

            // Set image as thumbnail
            function setThumbnail(index) {
                // Unset all thumbnails
                currentImages.forEach((img) => (img.isThumbnail = false));

                // Set new thumbnail
                currentImages[index].isThumbnail = true;

                // Re-render gallery
                renderGallery();

                showNotification('Thumbnail updated!', 'success');
            }

            // Remove image from gallery
            function removeImage(index) {
                const wasThumbnail = currentImages[index].isThumbnail;
                currentImages.splice(index, 1);

                // If we removed the thumbnail and there are still images, set first as thumbnail
                if (wasThumbnail && currentImages.length > 0) {
                    currentImages[0].isThumbnail = true;
                }

                renderGallery();
                showNotification('Image removed', 'success');
            }

            // Drag and drop handlers
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    processImageFile(file);
                }
            }

            function processImageFile(file) {
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select an image file', 'error');
                    return;
                }

                // Check file size (warn if > 500KB)
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                if (file.size > 500 * 1024) {
                    showNotification(
                        `Warning: Large file size (${sizeMB}MB). Consider compressing the image.`,
                        'error'
                    );
                }

                // Show file name
                document.getElementById(
                    'fileName'
                ).textContent = `${file.name} (${sizeMB}MB)`;

                // Convert to base64 and add to gallery
                const reader = new FileReader();
                reader.onload = function (e) {
                    const base64 = e.target.result;

                    // Add to current images array
                    currentImages.push({
                        url: base64,
                        isThumbnail: currentImages.length === 0, // First image is thumbnail by default
                        uploadedAt: new Date(),
                    });

                    // Update gallery display
                    renderGallery();

                    // Clear the file input and preview
                    document.getElementById('productImage').value = '';
                    document.getElementById('imagePreview').style.display =
                        'none';
                    document.getElementById('fileName').textContent = '';

                    showNotification('Image added to gallery!', 'success');
                };
                reader.readAsDataURL(file);
            }

            // Initialize drag and drop on page load
            function initializeDragAndDrop() {
                const uploadZone = document.getElementById('uploadZone');

                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(
                    (eventName) => {
                        uploadZone.addEventListener(
                            eventName,
                            preventDefaults,
                            false
                        );
                        document.body.addEventListener(
                            eventName,
                            preventDefaults,
                            false
                        );
                    }
                );

                // Highlight drop zone when item is dragged over it
                ['dragenter', 'dragover'].forEach((eventName) => {
                    uploadZone.addEventListener(
                        eventName,
                        () => {
                            uploadZone.classList.add('dragover');
                        },
                        false
                    );
                });

                ['dragleave', 'drop'].forEach((eventName) => {
                    uploadZone.addEventListener(
                        eventName,
                        () => {
                            uploadZone.classList.remove('dragover');
                        },
                        false
                    );
                });

                // Handle dropped files
                uploadZone.addEventListener('drop', handleDrop, false);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    processImageFile(files[0]);
                }
            }

            function addLinkItem() {
                const container = document.getElementById('linksContainer');
                const linkItem = document.createElement('div');
                linkItem.className = 'link-item';
                linkItem.innerHTML = `
                <input type="text" placeholder="Link name (e.g., Amazon)" class="link-name" />
                <input type="url" placeholder="https://..." class="link-url" />
                <button type="button" onclick="removeLinkItem(this)">Remove</button>
            `;
                container.appendChild(linkItem);
            }

            function removeLinkItem(button) {
                button.parentElement.remove();
            }

            async function saveProduct() {
                const name = document
                    .getElementById('productName')
                    .value.trim();
                const room = document.getElementById('productRoomSelect').value;

                if (!name || !room) {
                    showNotification(
                        'Please fill in all required fields',
                        'error'
                    );
                    return;
                }

                // Collect links
                const linkItems = document.querySelectorAll('.link-item');
                const links = [];
                linkItems.forEach((item) => {
                    const linkName = item
                        .querySelector('.link-name')
                        .value.trim();
                    const linkUrl = item
                        .querySelector('.link-url')
                        .value.trim();
                    if (linkName && linkUrl) {
                        links.push({ name: linkName, url: linkUrl });
                    }
                });

                // Get thumbnail image for backward compatibility
                const thumbnailImage = currentImages.find(
                    (img) => img.isThumbnail
                );

                const productData = {
                    description: name,
                    category: 'Products',
                    status: document.getElementById('productStatus').value,
                    quantity:
                        parseFloat(
                            document.getElementById('productQuantity').value
                        ) || 1,
                    unit: document.getElementById('productUnit').value.trim(),
                    budgetRate:
                        parseFloat(
                            document.getElementById('productBudgetPrice').value
                        ) || 0,
                    actualRate:
                        parseFloat(
                            document.getElementById('productActualPrice').value
                        ) || 0,
                    subtotal:
                        (parseFloat(
                            document.getElementById('productQuantity').value
                        ) || 1) *
                        (parseFloat(
                            document.getElementById('productActualPrice').value
                        ) || 0),
                    images: currentImages, // New gallery array
                    imageUrl: thumbnailImage?.url || '', // Backward compatibility
                    showImage: !!thumbnailImage, // Backward compatibility
                    links: links,
                    notes: document.getElementById('productNotes').value.trim(),
                    favorite: currentEditProduct?.favorite || false, // Preserve favorite status
                };

                try {
                    // Load current room data
                    const response = await fetch(`/api/load-room/${room}`);

                    if (!response.ok) {
                        throw new Error(
                            `Server error: ${response.status} ${response.statusText}`
                        );
                    }

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error('Failed to load room data');
                    }

                    let items = result.roomData.items || [];

                    if (
                        currentEditProduct &&
                        currentEditProduct.room === room
                    ) {
                        // Update existing product in same room
                        items[currentEditProduct.originalIndex] = productData;
                    } else if (
                        currentEditProduct &&
                        currentEditProduct.room !== room
                    ) {
                        // Moving product to different room - delete from old room first
                        await deleteProductFromRoom(
                            currentEditProduct.room,
                            currentEditProduct.originalIndex
                        );
                        // Add to new room
                        items.push(productData);
                    } else {
                        // New product
                        items.push(productData);
                    }

                    // Save to room
                    const saveResponse = await fetch(`/api/save-room/${room}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roomData: {
                                name: result.roomData.name,
                                budget: result.roomData.budget,
                                items: items,
                            },
                        }),
                    });

                    if (!saveResponse.ok) {
                        const errorText = await saveResponse.text();
                        console.error('Save error response:', errorText);
                        throw new Error(
                            `Server error: ${
                                saveResponse.status
                            } - ${errorText.substring(0, 100)}`
                        );
                    }

                    const saveResult = await saveResponse.json();

                    if (!saveResult.success) {
                        throw new Error(
                            saveResult.error || 'Failed to save product'
                        );
                    }

                    showNotification('Product saved successfully!', 'success');
                    closeModal();
                    await loadProducts();
                } catch (error) {
                    console.error('Error saving product:', error);
                    showNotification(
                        'Error saving product: ' + error.message,
                        'error'
                    );
                }
            }

            async function deleteProductFromRoom(room, index) {
                const response = await fetch(`/api/load-room/${room}`);
                const result = await response.json();

                if (result.success) {
                    let items = result.roomData.items || [];
                    items.splice(index, 1);

                    await fetch(`/api/save-room/${room}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items }),
                    });
                }
            }

            function openFirstLink(uniqueId) {
                const product = filteredProducts.find(
                    (p) => p.uniqueId === uniqueId
                );
                if (product && product.links && product.links.length > 0) {
                    window.open(product.links[0].url, '_blank');
                }
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                const modal = document.getElementById('productModal');
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function () {
                initializeDragAndDrop();
                loadProducts();
            });
        </script>
    </body>
</html>
