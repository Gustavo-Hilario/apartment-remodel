<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Apartment Remodel - Budget Overview</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                margin: 0;
                font-size: 2.5em;
                font-weight: 300;
            }

            .header p {
                margin: 10px 0 0 0;
                opacity: 0.9;
                font-size: 1.1em;
            }

            .nav {
                margin-top: 20px;
                display: flex;
                justify-content: center;
                gap: 15px;
                flex-wrap: wrap;
            }

            .nav a {
                color: white;
                text-decoration: none;
                padding: 8px 16px;
                border-radius: 5px;
                background: rgba(255, 255, 255, 0.2);
                transition: background 0.3s ease;
            }

            .nav a:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .content {
                padding: 30px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                border-left: 4px solid #667eea;
            }

            .stat-card h3 {
                margin: 0 0 10px 0;
                color: #333;
                font-size: 0.9em;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .stat-card .value {
                font-size: 1.8em;
                font-weight: bold;
                color: #667eea;
            }

            .chart-container {
                position: relative;
                height: 400px;
                margin: 30px 0;
            }

            .room-details {
                margin-top: 30px;
            }

            .room-details table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 10px;
                overflow: hidden;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .room-details th {
                background: #667eea;
                color: white;
                padding: 15px;
                text-align: left;
            }

            .room-details td {
                padding: 12px 15px;
                border-bottom: 1px solid #eee;
            }

            .room-details tr:hover {
                background: #f8f9fa;
            }

            .status-completed {
                background: #28a745;
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8em;
            }

            .status-pending {
                background: #ffc107;
                color: #333;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8em;
            }

            .positive {
                color: #28a745;
                font-weight: bold;
            }

            .negative {
                color: #dc3545;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üè† Apartment Remodel</h1>
                <p>Budget Overview & Progress Tracking</p>
                <div class="nav">
                    <a href="../home.html">üè† Home</a>
                    <a href="budget-overview.html">üìä Dashboard</a>
                    <a href="room-editor.html">‚úèÔ∏è Editor</a>
                    <a href="products.html">üõçÔ∏è Products</a>
                    <a href="../README.html">üìñ Documentation</a>
                </div>
            </div>

            <div class="content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Budget</h3>
                        <div class="value" id="totalBudget">S/ 170,000</div>
                    </div>
                    <div class="stat-card">
                        <h3>Spent So Far</h3>
                        <div class="value" id="totalSpent">S/ 70,067</div>
                    </div>
                    <div class="stat-card">
                        <h3>Remaining</h3>
                        <div class="value" id="remaining">S/ 99,933</div>
                    </div>
                    <div class="stat-card">
                        <h3>Progress</h3>
                        <div class="value" id="progress">41.2%</div>
                    </div>
                </div>

                <!-- View Selector -->
                <div style="margin-bottom: 20px; text-align: center">
                    <label
                        for="viewSelector"
                        style="font-weight: bold; margin-right: 10px"
                        >View:</label
                    >
                    <select
                        id="viewSelector"
                        onchange="changeView()"
                        style="
                            padding: 10px 20px;
                            font-size: 16px;
                            border: 2px solid #667eea;
                            border-radius: 5px;
                            background: white;
                            cursor: pointer;
                        "
                    >
                        <option value="overview">üìä Project Overview</option>
                        <option value="room">üè† Room Details</option>
                    </select>

                    <select
                        id="roomSelector"
                        onchange="loadRoomDetails()"
                        style="
                            padding: 10px 20px;
                            font-size: 16px;
                            border: 2px solid #667eea;
                            border-radius: 5px;
                            background: white;
                            margin-left: 10px;
                            display: none;
                            cursor: pointer;
                        "
                    >
                        <option value="">Select a room...</option>
                    </select>
                </div>

                <div class="chart-container">
                    <canvas id="budgetChart"></canvas>
                </div>

                <div class="room-details">
                    <h2>Room-by-Room Breakdown</h2>
                    <table id="roomTable">
                        <thead>
                            <tr>
                                <th>Room</th>
                                <th>Budget</th>
                                <th>Actual</th>
                                <th>Difference</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // Function to parse Peruvian currency format
            function parseCurrency(value) {
                if (!value || value === '') return 0;
                return parseFloat(value.replace(/[S/\s,]/g, ''));
            }

            // Function to format currency
            function formatCurrency(value) {
                return `S/ ${value.toLocaleString('es-PE')}`;
            }

            // Load and display data
            async function loadData() {
                try {
                    const response = await fetch('../data/budget-overview.csv');
                    const csvText = await response.text();
                    const data = Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                    });

                    // Filter out the Total row from the data
                    const roomData = data.data.filter(
                        (row) =>
                            row.Room &&
                            !row.Room.toLowerCase().includes('total') &&
                            row.Room.trim() !== ''
                    );

                    allRoomsData = roomData; // Store for later use
                    displayChart(roomData);
                    displayTable(roomData);
                    updateStats(roomData);
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Fallback data
                    const fallbackData = [
                        {
                            Room: 'Sala',
                            Budget: 'S/ 30,000',
                            Actual: 'S/ 22,601',
                            Difference: 'S/ 7,399',
                            Status: 'Completed',
                        },
                        {
                            Room: 'Cocina',
                            Budget: 'S/ 40,000',
                            Actual: 'S/ 47,466',
                            Difference: '-S/ 7,466',
                            Status: 'Completed',
                        },
                        {
                            Room: 'Ba√±o Visita',
                            Budget: 'S/ 10,000',
                            Actual: '',
                            Difference: 'S/ 10,000',
                            Status: 'Pending',
                        },
                        {
                            Room: 'Cuarto 3',
                            Budget: 'S/ 15,000',
                            Actual: '',
                            Difference: 'S/ 15,000',
                            Status: 'Pending',
                        },
                        {
                            Room: 'Ba√±o 2',
                            Budget: 'S/ 15,000',
                            Actual: '',
                            Difference: 'S/ 15,000',
                            Status: 'Pending',
                        },
                        {
                            Room: 'Cuarto 2',
                            Budget: 'S/ 20,000',
                            Actual: '',
                            Difference: 'S/ 20,000',
                            Status: 'Pending',
                        },
                        {
                            Room: 'Cuarto 1',
                            Budget: 'S/ 20,000',
                            Actual: '',
                            Difference: 'S/ 20,000',
                            Status: 'Pending',
                        },
                        {
                            Room: 'Ba√±o 1',
                            Budget: 'S/ 15,000',
                            Actual: '',
                            Difference: 'S/ 15,000',
                            Status: 'Pending',
                        },
                        {
                            Room: 'Balc√≥n',
                            Budget: 'S/ 5,000',
                            Actual: '',
                            Difference: 'S/ 5,000',
                            Status: 'Pending',
                        },
                    ];

                    displayChart(fallbackData);
                    displayTable(fallbackData);
                    updateStats(fallbackData);
                }
            }

            function displayChart(data) {
                const ctx = document
                    .getElementById('budgetChart')
                    .getContext('2d');

                // Destroy existing chart if it exists
                if (currentChart) {
                    currentChart.destroy();
                }

                const rooms = data.map((row) => row.Room);
                const budgets = data.map((row) => parseCurrency(row.Budget));
                const actuals = data.map(
                    (row) => parseCurrency(row.Actual) || 0
                );

                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: rooms,
                        datasets: [
                            {
                                label: 'Budget',
                                data: budgets,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1,
                            },
                            {
                                label: 'Actual',
                                data: actuals,
                                backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                borderColor: 'rgba(118, 75, 162, 1)',
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Budget vs Actual Spending by Room',
                                font: {
                                    size: 16,
                                },
                            },
                            legend: {
                                position: 'top',
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value, index, values) {
                                        return formatCurrency(value);
                                    },
                                },
                            },
                        },
                    },
                });
            }

            function displayTable(data) {
                const tbody = document.querySelector('#roomTable tbody');
                const thead = document.querySelector('#roomTable thead tr');

                // Reset headers for overview
                thead.innerHTML = `
                <th>Room</th>
                <th>Budget</th>
                <th>Actual</th>
                <th>Difference</th>
                <th>Status</th>
            `;

                tbody.innerHTML = '';

                data.forEach((row) => {
                    const tr = document.createElement('tr');
                    const difference = parseCurrency(row.Difference);
                    const isPositive = difference > 0;

                    tr.innerHTML = `
                    <td><strong>${row.Room}</strong></td>
                    <td>${row.Budget}</td>
                    <td>${row.Actual || 'Not started'}</td>
                    <td class="${isPositive ? 'positive' : 'negative'}">${
                        row.Difference
                    }</td>
                    <td><span class="status-${row.Status.toLowerCase()}">${
                        row.Status
                    }</span></td>
                `;
                    tbody.appendChild(tr);
                });
            }

            function updateStats(data) {
                const totalBudget = data.reduce(
                    (sum, row) => sum + parseCurrency(row.Budget),
                    0
                );
                const totalSpent = data.reduce(
                    (sum, row) => sum + parseCurrency(row.Actual),
                    0
                );
                const remaining = totalBudget - totalSpent;
                const progress = ((totalSpent / totalBudget) * 100).toFixed(1);

                document.getElementById('totalBudget').textContent =
                    formatCurrency(totalBudget);
                document.getElementById('totalSpent').textContent =
                    formatCurrency(totalSpent);
                document.getElementById('remaining').textContent =
                    formatCurrency(remaining);
                document.getElementById(
                    'progress'
                ).textContent = `${progress}%`;
            }

            let allRoomsData = [];
            let currentChart = null;

            // Change view between overview and room details
            function changeView() {
                const viewSelector = document.getElementById('viewSelector');
                const roomSelector = document.getElementById('roomSelector');

                if (viewSelector.value === 'room') {
                    roomSelector.style.display = 'inline-block';
                    // Populate room selector if not already done
                    if (
                        roomSelector.options.length === 1 &&
                        allRoomsData.length > 0
                    ) {
                        allRoomsData.forEach((room) => {
                            const option = document.createElement('option');
                            option.value = room.Room;
                            option.textContent = room.Room;
                            roomSelector.appendChild(option);
                        });
                    }
                } else {
                    roomSelector.style.display = 'none';
                    // Show overview
                    if (allRoomsData.length > 0) {
                        displayChart(allRoomsData);
                        displayTable(allRoomsData);
                    }
                }
            }

            // Load individual room details
            async function loadRoomDetails() {
                const roomSelector = document.getElementById('roomSelector');
                const selectedRoom = roomSelector.value;

                if (!selectedRoom) return;

                try {
                    // Map room names to file names
                    const roomFileMap = {
                        Cocina: 'cocina',
                        Sala: 'sala',
                        'Cuarto 1': 'cuarto1',
                        'Cuarto 2': 'cuarto2',
                        'Cuarto 3': 'cuarto3',
                        'Ba√±o 1': 'bano1',
                        'Ba√±o 2': 'bano2',
                        'Ba√±o Visita': 'bano_visita',
                        Balc√≥n: 'balcon',
                    };

                    const roomFileName = roomFileMap[selectedRoom];
                    if (!roomFileName) return;

                    // Load room data from API
                    const response = await fetch(
                        `/api/load-room/${roomFileName}`
                    );
                    const result = await response.json();

                    if (result.success && result.roomData) {
                        displayRoomChart(result.roomData);
                        displayRoomTable(result.roomData);
                        updateRoomStats(result.roomData);
                    }
                } catch (error) {
                    console.error('Error loading room details:', error);
                }
            }

            // Display chart for individual room
            function displayRoomChart(roomData) {
                const ctx = document
                    .getElementById('budgetChart')
                    .getContext('2d');

                // Destroy existing chart if it exists
                if (currentChart) {
                    currentChart.destroy();
                }

                // Get categories and their totals
                const categories = {};
                roomData.items.forEach((item) => {
                    if (!categories[item.category]) {
                        categories[item.category] = { budget: 0, actual: 0 };
                    }
                    categories[item.category].budget +=
                        item.budgetRate * item.quantity;
                    categories[item.category].actual +=
                        item.actualRate * item.quantity;
                });

                const labels = Object.keys(categories);
                const budgets = labels.map((cat) => categories[cat].budget);
                const actuals = labels.map((cat) => categories[cat].actual);

                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Budget',
                                data: budgets,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 1,
                            },
                            {
                                label: 'Actual',
                                data: actuals,
                                backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                borderColor: 'rgba(118, 75, 162, 1)',
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${roomData.name} - Budget vs Actual by Category`,
                                font: { size: 16 },
                            },
                            legend: { position: 'top' },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return formatCurrency(value);
                                    },
                                },
                            },
                        },
                    },
                });
            }

            // Display table for individual room
            function displayRoomTable(roomData) {
                const tbody = document.querySelector('#roomTable tbody');
                const thead = document.querySelector('#roomTable thead tr');

                // Update table headers
                thead.innerHTML = `
                <th>Description</th>
                <th>Category</th>
                <th>Qty</th>
                <th>Budget Price</th>
                <th>Actual Price</th>
                <th>Subtotal</th>
                <th>Status</th>
            `;

                tbody.innerHTML = '';
                roomData.items.forEach((item) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td><strong>${item.description}</strong></td>
                    <td>${item.category}</td>
                    <td>${item.quantity} ${item.unit || ''}</td>
                    <td>${formatCurrency(item.budgetRate)}</td>
                    <td>${formatCurrency(item.actualRate)}</td>
                    <td>${formatCurrency(item.subtotal)}</td>
                    <td><span class="status-${item.status.toLowerCase()}">${
                        item.status
                    }</span></td>
                `;
                    tbody.appendChild(tr);
                });
            }

            // Update stats for individual room
            function updateRoomStats(roomData) {
                const totalBudget = roomData.budget;
                const totalSpent = roomData.items.reduce(
                    (sum, item) => sum + item.subtotal,
                    0
                );
                const remaining = totalBudget - totalSpent;
                const progress = ((totalSpent / totalBudget) * 100).toFixed(1);

                document.getElementById('totalBudget').textContent =
                    formatCurrency(totalBudget);
                document.getElementById('totalSpent').textContent =
                    formatCurrency(totalSpent);
                document.getElementById('remaining').textContent =
                    formatCurrency(remaining);
                document.getElementById(
                    'progress'
                ).textContent = `${progress}%`;
            }

            // Load data when page loads
            window.addEventListener('load', loadData);
        </script>
    </body>
</html>
